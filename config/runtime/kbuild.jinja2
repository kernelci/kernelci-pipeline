{# -*- mode: Python -*- -#}
{# SPDX-License-Identifier: LGPL-2.1-or-later -#}

{%- extends 'base/python.jinja2' %}

{%- block python_imports %}
{{ super() }}
{%- endblock %}

{%- block python_local_imports %}
{{ super() }}
from kernelci.kbuild import KBuild
import os
import sys
{%- endblock %}

{%- block python_globals %}
{{ super() }}
KBUILD_PARAMS = {
    'arch': '{{ arch }}',
    'compiler': '{{ compiler }}',
    'defconfig': '{{ defconfig }}',
{%- if fragments %}
    'fragments': {{ fragments }}
{%- else %}
    'fragments': []
{%- endif %}
}
{%- endblock %}

{% block python_job -%}

CROS_CONFIG_URL = \
    "https://chromium.googlesource.com/chromiumos/third_party/kernel/+archive/refs/heads/{branch}/chromeos/config.tar.gz"  # noqa

LEGACY_FRAG_CONFIG = '/etc/kernelci/core/build-configs.yaml'

WORKSPACE = '/tmp/kci'

def main(args):
    build = KBuild(node=NODE, jobname=JOB_NAME, params=KBUILD_PARAMS)
    build.set_workspace(WORKSPACE)
    build.set_api_config(API_CONFIG_YAML)
    build.set_storage_config(STORAGE_CONFIG_YAML)
    build.write_script("build.sh")
    build.serialize("_build.json")
    r = os.system("bash build.sh")
    build2 = KBuild.from_json("_build.json")
    build2.verify_build()
    results = build2.submit(r)
    return results

{% endblock %}

{%- block python_main %}
if __name__ == '__main__':
    main(sys.argv)
    sys.exit(0)
{%- endblock %}
